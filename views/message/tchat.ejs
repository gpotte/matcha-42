<% include ../partials/header %>
<div class=container>
  <ul clas="list-group" id="message"></ul>
  <form id="tchatForm">
    <div class="input-group">
      <input id="tchatInput" type="text" autocomplete="off" class="form-control" required=true>
      <span class="input-group-btn">
        <button class="btn btn-default btn-primary">Send</button>
      </span>
    </div>
  </form>
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
  var getSegment = function (url, index) {
    return url.replace(/^https?:\/\//, '').split('/')[index];
 }
  $(function () {
    var socket = io();
    $(document).ready(function(){
      socket.emit('subscribe', {user: "<%=user.username%>", room: getSegment(window.location.href, 2)});
    });
    $('#tchatForm').submit(function(){
      socket.emit('chat message', {msg: $('#tchatInput').val(), room: getSegment(window.location.href, 2)});
      $('#tchatInput').val('');
      return false;
    });
    socket.on('chat message', (msg)=>{
      var now = new Date(Date.now());
      if (msg.pseudo === "<%=user.username%>")
        $('#message').append("<li class='list-group-item'><strong>"+
                              msg.pseudo + " </strong>"+ msg.msg +
                              "<span class='badge'>" + now.getHours() + ":" + now.getMinutes() + "</span></li>");
      else
        $('#message').append("<li class='list-group-item disabled'><strong>"+
                              msg.pseudo + " </strong>"+ msg.msg +
                              "<span class='badge'>" + now.getHours() + ":" + now.getMinutes() + "</span></li>");
    });
  });
</script>
<% include ../partials/footer %>
